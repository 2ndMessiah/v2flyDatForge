name: Build dlc.dat
on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 0'  # Run at 12:00 PM UTC (8:00 PM Singapore Time) every Sunday
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v5
        with:
          path: code
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: code/go.mod
          cache-dependency-path: code/go.sum
      - name: Set variables
        run: |
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          echo "TAG_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
        shell: bash


      - name: Install sing-box
        run: |
          curl -fsSL https://sing-box.app/install.sh | sh
          sing-box version

          
      - name: Build dlc.dat file
        run: |
          ls -lh
          pwd # we're at ......./v2flyDatForge/v2flyDatForge/code/
          cd code || exit 1
          cd data
          rm -rf *
          curl -L https://energized.pro/nsfw/domains.txt > nsfw
          cd ..
          go run ./ --outputdir=../
          cd ..
          curl -L https://energized.pro/nsfw/adblock.txt > adblock.txt
      
      - name: Build singbox srs rules.
        run: |
          sing-box rule-set convert ./adblock.txt  -t adguard -o nsfw.srs

      - name: Convert loyalsodier rules to mrs
        run: |
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.19.13/mihomo-linux-amd64-v1-v1.19.13.deb
          dpkg -i mihomo*
          wget https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt
          wget https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt
          wget https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt
          wget https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt
          wget https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt
          wget https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt
          mihomo convert-ruleset domain text reject.yaml reject.mrs
          mihomo convert-ruleset domain text proxy.yaml proxy.mrs
          mihomo convert-ruleset domain text direct.yaml direct.mrs
          mihomo convert-ruleset domain text private.yaml private.mrs
          mihomo convert-ruleset ipcidr text cncidr.yaml cncidr.mrs
          mihomo convert-ruleset ipcidr text lancidr.yaml lancidr.mrs


      - name: Generate dlc.dat sha256 hash
        run: |
          sha256sum dlc.dat > dlc.dat.sha256sum
      - name: Generate Zip
        run: |
          zip -9 dlc.dat.zip dlc.dat
          sha256sum dlc.dat.zip > dlc.dat.zip.sha256sum
      - name: Generate XZ
        run: |
          xz -z -9 -k dlc.dat
          sha256sum dlc.dat.xz > dlc.dat.xz.sha256sum
          

      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.RELEASE_NAME }}
          files: |
            /home/runner/work/v2flyDatForge/v2flyDatForge/dlc.dat 
            /home/runner/work/v2flyDatForge/v2flyDatForge/nsfw.srs
            /home/runner/work/v2flyDatForge/v2flyDatForge/*.mrs
